(function(){var t,e,n,i,o=function(t,e){function n(){this.constructor=t}for(var i in e)s.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;this.SeapigClient=function(){function e(t,e){null==e&&(e={}),this.uri=t,this.options=e,this.slave_objects={},this.master_objects={},this.connected=!1,this.socket=void 0,this.error=void 0,this.connect()}return e.prototype.connect=function(){var t;if(this.reconnect_on_close=!0,null!=this.socket)return this.socket.close();try{this.socket=new WebSocket(this.uri)}catch(e){return t=e,this.error={while:"connecting",error:t},null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),!1}return this.socket.onopen=function(t){return function(){var e,n,i,o,s;t.options.debug&&console.log("Connected to seapig server"),t.connected=!0,t.error=null,null!=t.onstatuschange_proc&&t.onstatuschange_proc(t),t.socket.send(JSON.stringify({action:"client-options-set",options:t.options})),i=t.slave_objects;for(e in i)n=i[e],t.socket.send(JSON.stringify({action:"object-consumer-register",pattern:e,"version-known":n.version})),n.validate();o=t.master_objects,s=[];for(e in o)n=o[e],s.push(t.socket.send(JSON.stringify({action:"object-producer-register",pattern:e,"version-known":n.version})));return s}}(this),this.socket.onclose=function(t){return function(){var e,n,i;t.options.debug&&console.log("Seapig connection closed"),t.connected=!1,t.socket=void 0,i=t.slave_objects;for(e in i)n=i[e],n.invalidate();if(null!=t.onstatuschange_proc&&t.onstatuschange_proc(t),t.reconnect_on_close)return t.reconnection_timer=setTimeout(function(){return t.reconnection_timer=void 0,t.connect()},2e3)}}(this),this.socket.onerror=function(t){return function(e){return t.options.debug&&console.log("Seapig socket error",e),t.error={while:"connected",error:e}}}(this),this.socket.onmessage=function(t){return function(e){var n,i,o,s,r,c,h;switch(o=JSON.parse(e.data),o.action){case"object-update":r=t.slave_objects;for(i in r)s=r[i],s.matches(o.id)&&s.patch(o);break;case"object-destroy":c=t.slave_objects;for(i in c)s=c[i],s.matches(o.id)&&s.destroy(o.id);h=t.master_objects;for(i in h)s=h[i],s.matches(o.id)&&s.destroy(o.id);break;case"object-produce":n=_.find(_.values(t.master_objects),function(t){return t.matches(o.id)}),!n&&t.options.debug&&console.error('Seapig server submitted invalid "produce" request',o),n&&n.produce(o.id,o["version-inferred"]);break;default:t.options.debug&&console.error("Seapig server submitted an unsupported message",o)}return null}}(this)},e.prototype.disconnect=function(){if(this.reconnect_on_close=!1,null!=this.reconnection_timer&&clearTimeout(this.reconnection_timer),null!=this.socket)return this.socket.close()},e.prototype.onstatuschange=function(t){return this.onstatuschange_proc=t,this},e.prototype.slave=function(t,e){if(null==e&&(e={}),e.object&&!e.version||!e.object&&e.version)throw"Both or none of 'object' and 'version' are needed";return this.slave_objects[t]=t.indexOf("*")>=0?new i(this,t,e):new n(this,t,e),this.connected&&this.socket.send(JSON.stringify({action:"object-consumer-register",pattern:t,"version-known":this.slave_objects[t].version})),this.slave_objects[t]},e.prototype.master=function(e,n){return null==n&&(n={}),this.master_objects[e]=e.indexOf("*")>=0?new SeapigWildcardMasterObject(this,e,n):new t(this,e,n),this.connected&&this.socket.send(JSON.stringify({action:"object-producer-register",pattern:e,"version-known":this.master_objects[e].version})),this.master_objects[e]},e.prototype.unlink=function(t){if(null!=this.slave_objects[t]&&(delete this.slave_objects[t],this.connected&&this.socket.send(JSON.stringify({action:"object-consumer-unregister",pattern:t}))),null!=this.master_objects[t]&&(delete this.master_objects[t],this.connected))return this.socket.send(JSON.stringify({action:"object-producer-unregister",pattern:t}))},e}(),e=function(){function t(t,e,n){this.client=t,this.id=e,this.destroyed=!1,this.object={},this.initialized=!!n.object,null!=n.object&&_.extend(this.object,n.object)}return t.prototype.destroy=function(t){if(this.destroyed=!0,null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),null!=this.ondestroy_proc)return this.ondestroy_proc(this)},t.prototype.matches=function(t){return t.match(new RegExp(this.id.replace(/[^A-Za-z0-9*]/g,"\\$&").replace("*",".*?")))},t.prototype.sanitized=function(){return JSON.parse(JSON.stringify(this.object))},t.prototype.ondestroy=function(t){return this.ondestroy_proc=t,this},t.prototype.onstatuschange=function(t){return this.onstatuschange_proc=t,this},t.prototype.unlink=function(){return this.client.unlink(this.id)},t}(),n=function(t){function e(t,n,i){e.__super__.constructor.call(this,t,n,i),this.version=i.version||0,this.valid=!1,this.received_at=null}return o(e,t),e.prototype.onchange=function(t){return this.onchange_proc=t,this},e.prototype.patch=function(t){var e,n,i,o,s;if(this.received_at=new Date,n=JSON.stringify(this.object),t["version-old"]&&0!==t["version-old"]&&null==t.value)_.isEqual(this.version,t["version-old"])||console.error("Seapig lost some updates, this shouldn't ever happen. object:",this.id," version:",this.version," message:",t);else{i=this.object;for(e in i)s=i[e],delete this.object[e]}if(null!=t.value){o=t.value;for(e in o)s=o[e],this.object[e]=s}else jsonpatch.apply(this.object,t.patch);if(this.version=t["version-new"],this.valid=!0,this.initialized=!0,null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),null!=this.onchange_proc&&n!==JSON.stringify(this.object))return this.onchange_proc(this)},e.prototype.validate=function(){if(this.valid=this.initialized,null!=this.onstatuschange_proc)return this.onstatuschange_proc(this)},e.prototype.invalidate=function(){if(this.valid=!1,null!=this.onstatuschange_proc)return this.onstatuschange_proc(this)},e}(e),t=function(t){function e(t,n,i){e.__super__.constructor.call(this,t,n,i),this.version=i.version||[(new Date).getTime(),0],this.shadow=this.sanitized(),this.stall=!1}return o(e,t),e.prototype.onproduce=function(t){return this.onproduce_proc=t,this},e.prototype.set=function(t){var e,n,i;if(null==t&&(t={}),null!=t.version&&(this.version=t.version),null!=t.object){this.stall=!1,n=this.object;for(e in n)i=n[e],delete this.object[e];_.extend(this.object,t.object)}else(t.object===!1||t.stall)&&(this.stall=!0);return this.shadow=this.sanitized(),this.initialized=!0,this.upload(0,{},this.version,!this.stall&&this.shadow)},e.prototype.bump=function(t){var e,n;return null==t&&(t={}),n=this.version,e=this.shadow,this.version=t.version||[n[0],n[1]+1],this.shadow=this.sanitized(),this.initialized=!0,this.upload(n,e,this.version,!this.stall&&this.shadow)},e.prototype.produce=function(t,e){if(null!=this.onproduce_proc)return this.onproduce_proc(this,e);if(!this.initialized)throw"Master object "+t+" has to either be initialized at all times or have an onproduce callback";return this.upload(0,{},this.version,this.shadow)},e.prototype.upload=function(t,e,n,i){var o;return this.client.connected&&(0===t||i===!1?this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-new":n,value:i})):(o=jsonpatch.compare(e,i),JSON.stringify(o).length<JSON.stringify(i).length?this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-old":t,"version-new":n,patch:o})):this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-new":n,value:i})))),this},e}(e),i=function(t){function e(t,n,i){e.__super__.constructor.call(this,t,n,i),this.children={}}return o(e,t),e.prototype.patch=function(t){return null==this.children[t.id]&&(this.children[t.id]=new n(this.client,t.id,{}).onchange(this.onchange_proc).onstatuschange(this.onstatuschange_proc),this.object[t.id]=this.children[t.id].object),this.children[t.id].patch(t)},e.prototype.destroy=function(t){var e;if(null!=(e=this.children[t]))return delete this.object[t],delete this.children[t],e.destroy(t)},e}(n)}).call(this);
//# sourceMappingURL=seapig-client.min.js.map
